import type { Article } from "../rss/index.js";

function trimToMax(input: string, maxLength: number): string {
  if (input.length <= maxLength) {
    return input;
  }
  return `${input.slice(0, maxLength - 1).trimEnd()}…`;
}

export function buildSummaryInput(articles: Article[]): string {
  const lines = articles.map((article, index) => {
    const title = trimToMax(article.title, 140);
    const summary = trimToMax(article.summary, 220);
    return `${index + 1}. ${title} — ${summary}`;
  });

  return [
    "다음은 RSS 뉴스 요약 목록입니다.",
    "각 항목은 제목(최대 140자)과 1줄 요약(최대 220자)만 포함합니다.",
    "",
    "지침 (매우 중요):",
    "- 반드시 지정된 JSON 스키마로만 응답하세요. 설명이나 부연 텍스트는 금지합니다.",
    "- URL, 매체명, 출처, 링크는 절대 포함하지 마세요.",
    "- 각 문장은 입력 기사 목록 중 하나와 1:1로 연결되어야 하며 sourceIndex를 반드시 포함해야 합니다.",
    "- sourceIndex는 입력 번호(1~N) 정수이며, 문장당 하나만 허용합니다.",
    "- 여러 기사를 종합한 문장, sourceIndex 누락, 범위 밖 숫자는 금지합니다.",
    "",
    "작성 원칙:",
    "- one_liner는 제목형 문장(예: '오늘 뉴스 요약')을 금지하며,",
    "  금리·투자심리·리스크 중 최소 1개를 포함한 시장 판단 문장으로 작성하세요.",
    "",
    "- 모든 문장은 반드시 아래 구조 중 하나를 따르세요:",
    "  1) 사실 → 시장에 미친 직접적 영향",
    "  2) 이벤트 → 금리·심리·수급·리스크의 즉각적 변화",
    "",
    "- 2단계 이상 추론은 금지합니다.",
    "  (예: 사건 → 공급 감소 → 가격 영향 ❌)",
    "  (예: 지표/정책 → 금리 기대 변화 → 투자심리 영향 ⭕)",
    "",
    "- 단순 사실 나열은 실패로 간주합니다.",
    "- 과도한 해석, 논리 비약, 일반론적 설명은 금지합니다.",
    "",
    "- 문장 수를 늘리지 말고, 한 문장 안에서 의미를 완결하세요.",
    "- 각 문장은 90자 내외의 문장형 불릿으로 작성하세요.",
    "",
    "- economy와 stock_market은 같은 원인을 반복하지 말고 관점이 겹치지 않게 작성하세요.",
    "  economy는 금리·환율·정책·지표의 의미 중심,",
    "  stock_market은 시장 반응·투자심리·자산 가격 움직임 중심으로 작성하세요.",
    "",
    "- 금리 인하/인상 기대를 언급할 때는",
    "  같은 문장 안에 그 이유(고용/물가/임금/경기 중 1개)를 짧게 포함하세요.",
    "",
    "섹션별 기준:",
    "- [경제] 지표·정책 변화가 금리·환율에 미친 직접적 의미를 중심으로 작성하세요.",
    "- [증시] 지수/자산 가격 움직임을 시장 반응, 투자심리, 실적 전망 중 하나와 연결하세요.",
    "- [부동산] 한국 시장만 다루며, 금리·정책·공급·수요 구조 변화만 허용합니다.",
    "- [글로벌] 지정학·제재·에너지·공급망 등 시장 리스크와 직접 연결된 이슈만 허용합니다.",
    "- [섹터] 실적·수요·밸류에이션·투자심리에 의미가 있을 때만 작성하고, 없으면 빈 배열로 두세요.",
    "",
    "절대 포함하지 말 것:",
    "- 개인·연예인·단일 사례",
    "- 사고·재해·사건 (자산 가격에 직접적 영향이 없는 경우)",
    "- 지자체 행사, MOU, 홍보성·사회공헌 뉴스",
    "- 지역 이슈 (전국 또는 주요 시장에 영향이 없는 경우)",
    "",
    "톤 및 정확성 가이드 (중요):",
    "- 단정적·확정적 표현을 피하고, 다음과 같은 완화 표현을 우선 사용하세요:",
    "  (예: '~되고 있다' ❌ → '~요인으로 작용하고 있다' ⭕, '~압력이 완화/확대됐다', '~가능성이 제기된다')",
    "",
    "- 인과관계가 2단계 이상으로 느껴질 경우,",
    "  결과를 확정적으로 서술하지 말고 '심리/압력/기대 변화' 수준으로 표현하세요.",
    "",
    "- 환율·자산 가격·공급 효과 등은",
    "  중간 논리가 명확하지 않으면 '직접적 변화' 대신",
    "  '영향 요인', '경계/완화 신호'로 서술하세요.",
    "",
    "- 글로벌·섹터 문장은 개별 기업의 반사이익 추정보다",
    "  구조적 리스크, 흐름, 불확실성 중심으로 작성하세요.",
    "",
    "출력 형식:",
    '- economy/stock_market/... 배열 요소는 {"text":"문장","sourceIndex":1} 형태로만 작성하세요.',
    "",
    "추가 품질 규칙:",
    "- one_liner에는 하루의 특징이 드러나는 전환 표현(예: '하지만', '속에서도', '반면')을 가능하면 1회 포함하세요.",
    "- '오늘 핵심 3개'는 판단 요약에 가깝게, 본문 섹션은 그 근거·맥락 중심으로 작성해 의미 중복을 피하세요.",
    "- '긍정적/부정적 영향을 미치고 있다' 같은 표현은 가능하면 구체적 반응(심리 유지, 경계 완화, 기대 변화)으로 대체하세요.",
    "- 섹터 문장에서 특정 기업의 성과 단정은 피하고, 수요·흐름·주목 요인 수준으로 표현하세요.",
    "",
    "출력 제한 규칙:",
    "- economy, stock_market, real_estate_kr 섹션은 최대 4개 문장까지만 작성하세요.",
    "- sector_focus, social_global, tomorrow_watchlist 섹션은 최대 2개 문장까지만 작성하세요.",
    "- 중요도가 낮은 문장은 과감히 생략하고, 핵심 판단에 기여하는 문장만 남기세요.",
    "",
    lines.join("\n"),
  ].join("\n");
}
